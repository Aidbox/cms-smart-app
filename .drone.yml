kind: pipeline
type: kubernetes
name: VCSmartApp

when:
  branch:
    - master
  event:
    - push

steps:
  - name: build-smart-app
    image: node:14.16.0-stretch
    commands:
      - export CI=false
      - npm ci
    when:
      branch:
        - master

  - name: push-smart-app-sandbox
    image: plugins/docker
    environment:
      REACT_APP_FHIR_SERVER:
        from_secret: sandbox_url
      REACT_APP_CLIENT_LOGIN:
        from_secret: sandbox_login
      REACT_APP_CLIENT_SMART:
        from_secret: sandbox_smart
      REACT_APP_SCOPE:
        from_secret: sandbox_scope
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      registry: eu.gcr.io
      repo: eu.gcr.io/villagecare/sof-sandbox
      context: .
      dockerfile: Dockerfile
      build_args_from_env:
        - REACT_APP_FHIR_SERVER
        - REACT_APP_CLIENT_LOGIN
        - REACT_APP_CLIENT_SMART
        - REACT_APP_SCOPE
    when:
      branch:
        - master
    depends_on:
      - build-smart-app

  - name: push-smart-app-dev
    image: plugins/docker
    environment:
      REACT_APP_FHIR_SERVER:
        from_secret: dev_url
      REACT_APP_CLIENT_LOGIN:
        from_secret: dev_login
      REACT_APP_CLIENT_SMART:
        from_secret: dev_smart
      REACT_APP_SCOPE:
        from_secret: dev_scope
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      registry: eu.gcr.io
      repo: eu.gcr.io/villagecare/sof-dev
      context: .
      dockerfile: Dockerfile
      build_args_from_env:
        - REACT_APP_FHIR_SERVER
        - REACT_APP_CLIENT_LOGIN
        - REACT_APP_CLIENT_SMART
        - REACT_APP_SCOPE
    when:
      branch:
        - master
    depends_on:
      - push-smart-app-sandbox

  - name: reload all  sof
    image: claranet/gcloud-kubectl-docker
    environment:
      cluster_service_account:
        from_secret: cluster_service_account
    commands:
      - echo $cluster_service_account > creds.json
      - gcloud auth activate-service-account --key-file creds.json
      - gcloud container clusters get-credentials villagecare --zone us-central1-c --project villagecare
      - kubectl -n dev rollout restart deployment dev-sof-dev
      - kubectl -n dev rollout restart deployment dev-sof-sandbox
    depends_on:
      - push-smart-app-dev
    when:
      branch:
        - master

